# .github/workflows/release_check.yml
name: Update Thorium version

on:
  schedule:
    # Runs hourly
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update-thorium:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate App Token
        id: generate_token
        uses: peter-murray/workflow-application-token-action@v4
        with:
          application_id: ${{ secrets.APP_ID }}
          application_private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Install dependencies (using Nix)
        run: |
          nix profile install nixpkgs#gh nixpkgs#jq nixpkgs#gnused nixpkgs#gnugrep nixpkgs#curl
          echo "$HOME/.nix-profile/bin" >> $GITHUB_PATH

      - name: Get current and latest versions
        id: versions
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # Extract current version from flake.nix (taking the first match)
          CURRENT_VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' flake.nix | head -n 1 || echo "0.0.0")
          echo "Current version found in flake.nix: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV

          echo "Fetching latest release from Alex313031/thorium..."
          # Get the latest release tag
          LATEST_TAG=$(gh api repos/Alex313031/thorium/releases/latest --jq .tag_name)
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
             echo "::error::Failed to fetch latest release tag."
             exit 1
          fi

          # Strip 'M' prefix if present to get clean version number
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^M//')

          echo "Latest version: $LATEST_VERSION (Tag: $LATEST_TAG)"
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "Thorium is up-to-date ($CURRENT_VERSION)."
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          else
            echo "Update needed: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: Check for existing Pull Request
        if: env.UPDATE_NEEDED == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          BRANCH_NAME: "update-thorium-${{ env.LATEST_VERSION }}"
        run: |
          EXISTING_PR_URL=$(gh pr list --head "$BRANCH_NAME" --base main --state open --json url --jq '.[0].url')
          if [ -n "$EXISTING_PR_URL" ]; then
            echo "::warning::PR already exists: $EXISTING_PR_URL"
            echo "PR_EXISTS=true" >> $GITHUB_ENV
          else
            echo "PR_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Update version and hashes
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false'
        env:
          CURRENT_VERSION: ${{ env.CURRENT_VERSION }}
          LATEST_VERSION: ${{ env.LATEST_VERSION }}
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          echo "Updating flake.nix from $CURRENT_VERSION to $LATEST_VERSION"

          # 1. Update version number globally (updates 'version = ...' and 'url = ...')
          sed -i "s/$CURRENT_VERSION/$LATEST_VERSION/g" flake.nix

          # 2. Update hashes for each variant
          VARIANTS=("AVX" "AVX2" "SSE3" "SSE4")
          
          for VARIANT in "${VARIANTS[@]}"; do
            echo "Processing variant: $VARIANT"
            
            # Construct URL (matching the pattern in flake.nix)
            # Pattern: https://github.com/Alex313031/thorium/releases/download/<TAG>/Thorium_Browser_<VER>_<VARIANT>.AppImage
            # Note: The TAG usually has 'M' prefix, VER does not.
            # We use LATEST_TAG for the folder, and LATEST_VERSION for filename
            
            DOWNLOAD_URL="https://github.com/Alex313031/thorium/releases/download/${LATEST_TAG}/Thorium_Browser_${LATEST_VERSION}_${VARIANT}.AppImage"
            echo "Download URL: $DOWNLOAD_URL"
            
            TEMP_FILE=$(mktemp)
            curl -sL "$DOWNLOAD_URL" -o "$TEMP_FILE"
            
            if [ ! -s "$TEMP_FILE" ]; then
              echo "::error::Failed to download $VARIANT from $DOWNLOAD_URL"
              rm -f "$TEMP_FILE"
              exit 1
            fi
            
            NEW_HASH=$(nix hash file --base64 "$TEMP_FILE" 2>/dev/null)
            rm -f "$TEMP_FILE"
            
            if [ -z "$NEW_HASH" ]; then
              echo "::error::Failed to calculate hash for $VARIANT"
              exit 1
            fi
            
            echo "New Hash for $VARIANT: $NEW_HASH"
            
            # Use sed to replace the hash for this specific variant
            # Logic: Find line containing the Variant's AppImage URL, then update the *next* line starting with 'hash ='
            sed -i -E "/_${VARIANT}\.AppImage/ { n; s/hash = \".*\";/hash = \"sha256-${NEW_HASH}\";/ }" flake.nix
          done

      - name: Configure Git
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false'
        run: |
          git config --global user.email "flakebuilderapp[bot]@users.noreply.github.com"
          git config --global user.name "flakebuilderapp[bot]"

      - name: Check for changes
        id: git_status
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false'
        run: |
          git add flake.nix
          if git diff --staged --quiet; then
            echo "No changes detected."
            echo "CHANGES_EXIST=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected."
            echo "CHANGES_EXIST=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && steps.git_status.outputs.CHANGES_EXIST == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate_token.outputs.token }}
          author: "flakebuilderapp[bot] <flakebuilderapp[bot]@users.noreply.github.com>"
          committer: "flakebuilderapp[bot] <flakebuilderapp[bot]@users.noreply.github.com>"
          labels: automated, thorium-update
          delete-branch: true
          commit-message: "feat: Update Thorium to ${{ env.LATEST_VERSION }}"
          title: "feat: Update Thorium to ${{ env.LATEST_VERSION }}"
          body: |
            This PR automatically updates `thorium` to version `${{ env.LATEST_VERSION }}`.
            
            Variants updated: AVX, AVX2, SSE3, SSE4.
          branch: "update-thorium-${{ env.LATEST_VERSION }}"
          base: main

      - name: Enable Automerge
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && steps.create_pr.outputs.pull-request-number
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: "squash"
